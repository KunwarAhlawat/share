<%- include('../../partials/header.ejs', { title: title }) %>

  <div class="page-content">
    <!-- Main sidebar -->
    <%- include('../../partials/sidebar.ejs') %>
      <!-- /main sidebar -->

      <!-- Main content -->
      <div class="content-wrapper">
        <!-- Main navbar -->
        <%- include('../../component/dashboard/navbar.ejs') %>
          <!-- /main navbar -->

          <!-- Inner content -->
          <div class="content-inner">

            <!-- Content firm -->
            <div class="content">
              <!-- Nested object data -->
              <div class="card">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                      <%= title %>
                    </h5>
                    <!-- Button to trigger modal -->
                    <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#add-firm-model">
                      Add firm<i class="ph ph-navigation-arrow ms-2"></i>
                    </button>
                  </div>
                </div>

                <table class="table datatable-nested">
                  <thead>
                    <tr>
                      <th>Firm</th>
                      <th>GST Number</th>
                      <th>Product Produced</th>
                      <th>Quantity</th>
                      <th>Account Number</th>
                      <th>Bank</th>
                      <th>IFSC Code</th>
                      <th>Address</th>
                      <th>Pincode</th>
                      <th>Customers</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Data will be dynamically injected here -->
                  </tbody>
                </table>

              </div>
              <!-- /nested object data -->

            </div>
            <!-- /content firm -->
          </div>
          <!-- /inner content -->
      </div>
      <!-- /main content -->
  </div>
  <!-- /page content -->


  <!-- Models -->
  <!-- Add Firm Modal -->
  <div id="add-firm-model" class="modal fade" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-full">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Firm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-firm-form">

            <!-- Firm Basic Information -->
            <div class="form-section mb-4">
              <div class="row">
                <!-- Firm Name -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="firm_name" class="form-label">Firm Name*</label>
                    <input type="text" id="firm_name" class="form-control" name="firm_name" minlength="3"
                      maxlength="255" pattern="^[a-zA-Z\s]+(?:[a-zA-Z\s0-9]+)*$" required>
                    <small class="form-text text-muted">Firm name can contain letters, spaces, and optional
                      digits.</small>
                    <div id="firm_name_error" class="invalid-feedback">Firm name already exists.</div>
                  </div>
                </div>

                <!-- GST Number -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="firm_gst_number" class="form-label">GST Number</label>
                    <input type="text" id="firm_gst_number" class="form-control" name="firm_gst_number"
                      pattern="^[a-zA-Z0-9]+$">
                    <small class="form-text text-muted">GST number must be in a valid format.</small>
                    <div id="gst_number_error" class="invalid-feedback">GST number already exists.</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <!-- Address -->
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="firm_address" class="form-label">Address</label>
                    <input type="text" id="firm_address" class="form-control" name="firm_address" minlength="5"
                      maxlength="255">
                    <small class="form-text text-muted">Address must be between 5 and 255 characters.</small>
                  </div>
                </div>

                <!-- Pincode -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="firm_pincode" class="form-label">Pincode</label>
                    <input type="text" id="firm_pincode" class="form-control" name="firm_pincode" pattern="\d{6}">
                    <small class="form-text text-muted">Pincode must be exactly 6 digits.</small>
                  </div>
                </div>


              </div>
            </div>

            <!-- Bank Information -->
            <div class="form-section mb-4">
              <div class="row">

                <!-- Bank Account Number -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="firm_account_number" class="form-label">Account Number</label>
                    <input type="text" id="firm_account_number" class="form-control" name="firm_account_number"
                      pattern="\d{10,18}">
                    <small class="form-text text-muted">Account number must be between 10 and 18 digits.</small>
                    <div id="account_number_error" class="invalid-feedback">Account number already exists.</div>
                  </div>
                </div>
                <!-- Bank Name -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="firm_bank_name" class="form-label">Bank Name</label>
                    <input type="text" id="firm_bank_name" class="form-control" name="firm_bank_name" minlength="3"
                      maxlength="255">
                    <small class="form-text text-muted">Bank name must be between 3 and 255 characters.</small>
                  </div>
                </div>

                <!-- IFSC Code -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="firm_ifsc_code" class="form-label">IFSC Code</label>
                    <input type="text" id="firm_ifsc_code" class="form-control" name="firm_ifsc_code"
                      pattern="^[a-zA-Z0-9]+$">
                    <small class="form-text text-muted">IFSC code must be exactly 11 alphanumeric characters.</small>
                    <div id="ifsc_code_error" class="invalid-feedback">IFSC code must be valid.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Product Information -->
            <div class="form-section mb-4">
              <div class="row">
                <!-- Product Produced -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="firm_product_produced" class="form-label">Product Produced</label>
                    <input type="text" id="firm_product_produced" class="form-control" name="firm_product_produced"
                      minlength="3" maxlength="255">
                    <small class="form-text text-muted">Product description must be between 3 and 255
                      characters.</small>
                  </div>
                </div>

                <!-- Quantity -->
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="firm_quantity" class="form-label">Quantity</label>
                    <input type="number" id="firm_quantity" class="form-control" name="firm_quantity" min="1">
                    <small class="form-text text-muted">Quantity must be a whole number greater than or equal to
                      1.</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Information -->
            <div class="form-section mb-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_ids" class="form-label">Select Customer</label>
                    <button type="button" class="btn btn-link">Add New Customer</button>
                    <select class="form-control multiselect" multiple="multiple" name="customer_ids[]"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% customers.forEach(function(item) { %>
                        <option value="<%= item.customerId %>">
                          <%= item.customerName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Select the applicable customer(s).</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Submission -->
            <div class="mb-4">
              <button type="submit" class="btn btn-success">Add Firm</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Firm Modal -->
  <div id="edit-firm-model" class="modal fade" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-full">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Firm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="edit-firm-form">

            <!-- Firm Basic Information -->
            <div class="form-section mb-4">
              <div class="row">
                <!-- Firm Name -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit_firm_name" class="form-label">Firm Name*</label>
                    <input type="text" id="edit_firm_name" class="form-control" name="edit_firm_name" minlength="3"
                      maxlength="255" pattern="^[a-zA-Z\s]+(?:[a-zA-Z\s0-9]+)*$" required>
                    <small class="form-text text-muted">Firm name can contain letters, spaces, and optional
                      digits.</small>
                    <div id="firm_name_error" class="invalid-feedback">Firm name already exists.</div>
                  </div>
                </div>

                <!-- GST Number -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit_firm_gst_number" class="form-label">GST Number</label>
                    <input type="text" id="edit_firm_gst_number" class="form-control" name="edit_firm_gst_number"
                      pattern="^[a-zA-Z0-9]+$">
                    <small class="form-text text-muted">GST number must be in a valid format.</small>
                    <div id="gst_number_error" class="invalid-feedback">GST number already exists.</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <!-- Address -->
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="edit_firm_address" class="form-label">Address</label>
                    <input type="text" id="edit_firm_address" class="form-control" name="edit_firm_address"
                      minlength="5" maxlength="255">
                    <small class="form-text text-muted">Address must be between 5 and 255 characters.</small>
                  </div>
                </div>

                <!-- Pincode -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="edit_firm_pincode" class="form-label">Pincode</label>
                    <input type="text" id="edit_firm_pincode" class="form-control" name="edit_firm_pincode"
                      pattern="\d{6}">
                    <small class="form-text text-muted">Pincode must be exactly 6 digits.</small>
                  </div>
                </div>


              </div>
            </div>

            <!-- Bank Information -->
            <div class="form-section mb-4">
              <div class="row">

                <!-- Bank Account Number -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="edit_firm_account_number" class="form-label">Account Number</label>
                    <input type="text" id="edit_firm_account_number" class="form-control"
                      name="edit_firm_account_number" pattern="\d{10,18}">
                    <small class="form-text text-muted">Account number must be between 10 and 18 digits.</small>
                    <div id="account_number_error" class="invalid-feedback">Account number already exists.</div>
                  </div>
                </div>
                <!-- Bank Name -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="edit_firm_bank_name" class="form-label">Bank Name</label>
                    <input type="text" id="edit_firm_bank_name" class="form-control" name="edit_firm_bank_name"
                      minlength="3" maxlength="255">
                    <small class="form-text text-muted">Bank name must be between 3 and 255 characters.</small>
                  </div>
                </div>

                <!-- IFSC Code -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="edit_firm_ifsc_code" class="form-label">IFSC Code</label>
                    <input type="text" id="edit_firm_ifsc_code" class="form-control" name="edit_firm_ifsc_code"
                      pattern="^[a-zA-Z0-9]+$">
                    <small class="form-text text-muted">IFSC code must be exactly 11 alphanumeric characters.</small>
                    <div id="ifsc_code_error" class="invalid-feedback">IFSC code must be valid.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Product Information -->
            <div class="form-section mb-4">
              <div class="row">
                <!-- Product Produced -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit_firm_product_produced" class="form-label">Product Produced</label>
                    <input type="text" id="edit_firm_product_produced" class="form-control"
                      name="edit_firm_product_produced" minlength="3" maxlength="255">
                    <small class="form-text text-muted">Product description must be between 3 and 255
                      characters.</small>
                  </div>
                </div>

                <!-- Quantity -->
                <div class="col-md-3">
                  <div class="mb-3">
                    <label for="edit_firm_quantity" class="form-label">Quantity</label>
                    <input type="number" id="edit_firm_quantity" class="form-control" name="edit_firm_quantity" min="1">
                    <small class="form-text text-muted">Quantity must be a whole number greater than or equal to
                      1.</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Information -->
            <div class="form-section mb-4">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="edit_customer_ids" class="form-label">Select Customer</label>
                    <button type="button" class="btn btn-link">Add New Customer</button>
                    <select class="form-control multiselect" multiple="multiple" name="edit_customer_ids"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% customers.forEach(function(item) { %>
                        <option value="<%= item.customerId %>">
                          <%= item.customerName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Select the applicable customer(s).</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Submission -->
            <div class="mb-4">
              <button type="submit" class="btn btn-success">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>



  <script>


    // Function to render firm table
    function renderFirmTable() {
      renderTable({
        tableClassName: '.datatable-nested',
        apiURl: '/api/firms/',
        columns: [
          { data: "firmName" },
          { data: "GSTNumber" },
          { data: "productProduced" },
          { data: "quantity" },
          { data: "accountNumber" },
          { data: "bankName" },
          { data: "IFSCcode" },
          { data: "address" },
          { data: "pincode" },
          {
            data: "customers",
            render: function (data, type, row) {
              if (Array.isArray(data) && data.length > 0) {
                // Join customer names into a single string

                return data.map(customer => customer.customerName).join(', ');
              } else {
                return 'No Customers';
              }
            }
          },
          {
            data: null,
            className: "text-center",
            render: function (data, type, row) {
              return `
                    <button type="button" class="btn btn-primary btn-sm" 
                            onclick="setData('${row.firmId}','${row.firmName}')">
                        <i class="ph ph-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm ms-2" 
                            onclick="deleteData('${row.firmId}','${row.firmName}')">
                        <i class="ph ph-trash"></i>
                    </button>
                `;
            }
          }
        ]
      });
    }


    // Function to handle adding a new firm
    function addFirm() {
      $('#add-firm-form').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        ajaxRequest('/api/firm/create', 'POST', formData, function (response) {
          $('#add-firm-model').modal('hide');
          showSuccessToast(`Firm "${formData.get('firm_name')}" added successfully!`);
          setTimeout(() => location.reload(), 1500);
        }, function (xhr) {
          console.error('Error adding firm:', xhr);
          const response = JSON.parse(xhr.responseText);
          handleErrorResponse(response);
        });
      });
    }

    // Function to handle error responses
    function handleErrorResponse(response) {
      $('#firm_name_error').removeClass('invalid-feedback').show();
      $('#gst_number_error').removeClass('invalid-feedback').show();
      $('#account_number_error').removeClass('invalid-feedback').show();
      //debug
      console.log("Firm msg-----", response.message)
      if (response.message === "firm-name-found") {
        $('#firm_name_error').removeClass('invalid-feedback').show();  // Show firm name error
        $('#gst_number_error').addClass('invalid-feedback').hide();    // Hide other errors
        $('#account_number_error').addClass('invalid-feedback').hide();
      } else if (response.message === "gst-number-found") {
        $('#firm_name_error').addClass('invalid-feedback').hide();     // Hide firm name error
        $('#gst_number_error').removeClass('invalid-feedback').show(); // Show GST number error
        $('#account_number_error').addClass('invalid-feedback').hide();
      } else if (response.message === "account-number-found") {
        $('#firm_name_error').addClass('invalid-feedback').hide();     // Hide firm name error
        $('#gst_number_error').addClass('invalid-feedback').hide();    // Hide GST number error
        $('#account_number_error').removeClass('invalid-feedback').show(); // Show account number error
      }
    }

    // Function to populate the firm form
    function populateDataForm(id) {
      const updateModel = new bootstrap.Modal(document.getElementById('edit-firm-model'));
      updateModel.show();

      ajaxRequest(`/api/firm/${id}`, 'GET', null, function (response) {
        const firm = response.data;
        $('#edit_firm_name').val(firm.firmName);
        $('#edit_firm_gst_number').val(firm.GSTNumber);
        $('#edit_firm_address').val(firm.address);
        $('#edit_firm_pincode').val(firm.pincode);
        $('#edit_firm_account_number').val(firm.accountNumber);
        $('#edit_firm_bank_name').val(firm.bankName);
        $('#edit_firm_ifsc_code').val(firm.IFSCcode);
        $('#edit_firm_product_produced').val(firm.productProduced);
        $('#edit_firm_quantity').val(firm.quantity);



        const customerIds = firm.customers.map(customer => customer.customerId);
        $('#edit_customer_ids').val(customerIds);
        $('#edit_customer_ids').multiselect('refresh');
      }, function (xhr) {
        console.error('Error fetching firm details:', xhr);
      });
    }

    // Function to handle the edit request and form submission
    function setData(id, firmName) {
      populateDataForm(id);

      // Use .off() to remove any previous event listeners to avoid multiple bindings
      $('#edit-firm-form').off('submit').on('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        ajaxRequest(`/api/firm/update/${id}`, 'PUT', formData, function (response) {
          $('#edit-firm-model').modal('hide');
          showSuccessToast(`Firm "${formData.get('edit_firm_name')}" updated successfully!`);
          setTimeout(() => location.reload(), 1500);
        }, function (xhr) {
          console.error('Error:', xhr);
          const response = JSON.parse(xhr.responseText);
          handleErrorResponse(response);
        });
      });
    }

    // Main function to handle delete request
function deleteData(id, firmName) {
    if (!id) {
        alert("Invalid ID for deletion.");
        return;
    }

    // Show confirmation modal with the area name
    showDeleteConfirmationModal(firmName, () => {
        ajaxRequest(`/api/firm/delete/${id}`, 'DELETE', null, function(response) {
            if (response.success) {
                showSuccessToast(`Firm "${firmName}" deleted successfully!`);
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Error: ' + response.message);
            }
        }, function(xhr) {
            console.error('Error deleting data:', xhr);
            alert('Failed to delete data. Please try again.');
        });
    });
}


    // Initialize the data table and bind add data function
    $(document).ready(function () {
      renderFirmTable();
      addFirm();
    });
  </script>



  <%- include('../../partials/footer.ejs') %>
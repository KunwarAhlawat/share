<%- include('../../partials/header.ejs', { title: title }) %>

<div class="page-content">
  <!-- Main sidebar -->
  <%- include('../../partials/sidebar.ejs') %>
  <!-- /main sidebar -->

  <!-- Main content -->
  <div class="content-wrapper">
    <!-- Main navbar -->
    <%- include('../../component/dashboard/navbar.ejs') %>
    <!-- /main navbar -->

    <!-- Inner content -->
    <div class="content-inner">

      <!-- Content area -->
      <div class="content">
        <!-- Nested object data -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><%= title %></h5>
              <!-- Button to trigger modal -->
              <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#add-area-model">
                Add Area<i class="ph ph-navigation-arrow ms-2"></i>
              </button>
            </div>
          </div>

          <table class="table datatable-nested">
            <thead>
              <tr>
                <th>Area</th>
                <th>District</th>
                <th>Zone</th>
                <th>State</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be dynamically injected here -->
            </tbody>
          </table>
        
        </div>
        <!-- /nested object data -->

      </div>
      <!-- /content area -->
    </div>
    <!-- /inner content -->
  </div>
  <!-- /main content -->
</div>
<!-- /page content -->


<!-- Models -->
<!-- Add Area Modal -->
<div id="add-area-model" class="modal fade" tabindex="-1" style="display: none;" aria-hidden="true">
  <div class="modal-dialog modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Area</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="add-area-form">
         
          <!-- Area Basic Information -->
          <div class="form-section mb-4">
            <div class="row">
              <!-- Area Name -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="area_name" class="form-label">Area*</label>
                  <input type="text" id="area_name" class="form-control" name="area_name" minlength="4"
                    maxlength="20" pattern="^[A-Za-z0-9]+(?:\s[A-Za-z0-9]+)*$" required>
                  <small class="form-text text-muted">As per official documents</small>
                  <div id="area_name_error" class="invalid-feedback">Area with the same name already exists.</div>
                </div>
              </div>

              <!-- Zone -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="area_zone" class="form-label">Zone*</label>
                  <input type="text" id="area_zone" class="form-control" name="area_zone" minlength="4"
                    maxlength="20" pattern="^[A-Za-z0-9]+(?:\s[A-Za-z0-9]+)*$" required>
                  <small class="form-text text-muted">As per official documents</small>
                  <div id="zone_name_error" class="invalid-feedback">Zone with the same name already exists.</div>
                </div>
              </div>

              <!-- District -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="area_district" class="form-label">District*</label>
                  <input type="text" id="area_district" class="form-control" name="area_district" minlength="4"
                    maxlength="20" pattern="^[A-Za-z0-9]+(?:\s[A-Za-z0-9]+)*$" required>
                  <small class="form-text text-muted">As per official documents</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Area Status and Customer Information -->
          <div class="form-section mb-4">
            <div class="row">
              <!-- State -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="status" class="form-label">State*</label>
                  <select class="form-control" name="state" required>
                    <option value="" disabled selected>Select State</option>
                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                    <option value="Assam">Assam</option>
                    <option value="Bihar">Bihar</option>
                    <option value="Chhattisgarh">Chhattisgarh</option>
                    <option value="Goa">Goa</option>
                    <option value="Gujarat">Gujarat</option>
                    <option value="Haryana">Haryana</option>
                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                    <option value="Jharkhand">Jharkhand</option>
                    <option value="Karnataka">Karnataka</option>
                    <option value="Kerala">Kerala</option>
                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                    <option value="Maharashtra">Maharashtra</option>
                    <option value="Manipur">Manipur</option>
                    <option value="Meghalaya">Meghalaya</option>
                    <option value="Mizoram">Mizoram</option>
                    <option value="Nagaland">Nagaland</option>
                    <option value="Odisha">Odisha</option>
                    <option value="Punjab">Punjab</option>
                    <option value="Rajasthan">Rajasthan</option>
                    <option value="Sikkim">Sikkim</option>
                    <option value="Tamil Nadu">Tamil Nadu</option>
                    <option value="Telangana">Telangana</option>
                    <option value="Tripura">Tripura</option>
                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                    <option value="Uttarakhand">Uttarakhand</option>
                    <option value="West Bengal">West Bengal</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                    <option value="Ladakh">Ladakh</option>
                  </select>
                  <small class="form-text text-muted">Select the state the area belongs to</small>
                </div>
              </div>

              <!-- Customer Selection -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Select Customer</label>
                  <button type="button" class="btn btn-link">Add New Customer</button>
                  <select class="form-control multiselect" multiple="multiple" name="customer_ids"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% customers.forEach(function(item) { %>
                      <option value="<%= item.customerId %>">
                        <%= item.customerName %>
                      </option>
                    <% }) %>
                  </select>
                  <small class="form-text text-muted">Select the applicable customer(s)</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Submission -->
          <div class="mb-4">
            <button type="submit" class="btn btn-success">Add Area</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>




<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete the area: <strong id="deleteAreaName"></strong> ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- Toast Notification -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1055;">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Area deleted successfully!
      </div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<script>
   // area table
   renderTable({
      tableClassName: '.datatable-nested', apiURl: '/api/areas', columns: [
        { data: "areaName" },
        { data: "districtName" },
        { data: "zoneName" },
        { data: "stateName" },
        {
          data: null,
          className: "text-center",
          render: function (data, type, row) {
            return `
            <button type="button" class="btn btn-primary btn-sm" 
                    onclick="setData('${row.areaId}','${row.areaName}')">
                <i class="ph ph-pencil"></i>
            </button>
            <button type="button" class="btn btn-danger btn-sm ms-2" 
                    onclick="deleteData('${row.areaId}','${row.areaName}')">
                <i class="ph ph-trash"></i>
            </button>
        `;
          }
        }

      ]
    });


// Main function to handle delete request
function deleteData(id, areaName) {
    // Check if the ID is valid
    if (!id) {
        alert("Invalid ID for deletion.");
        return;
    }

    // Show confirmation modal with the area name
    showDeleteConfirmationModal(areaName, () => {
        // Once confirmed, proceed with the AJAX call
        $.ajax({
            url: `/api/area/delete/${id}`, // URL includes the ID of the item to delete
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    // Show the success toast with the area name
                    showSuccessToast(`Area "${areaName}" deleted successfully!`);
                    
                    // Optionally, reload the page after success
                    setTimeout(function() {
                        location.reload();
                    }, 1500); // Delay to let the toast show before reloading
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error deleting data:', error);
                alert('Failed to delete data. Please try again.');
            }
        });
    });
}

  
// Function to show delete confirmation modal
function showDeleteConfirmationModal(areaName, callback) {
    // Set the area name inside the modal
    document.getElementById('deleteAreaName').textContent = areaName;

    // Initialize the modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    
    // Show the modal
    deleteModal.show();
    
    // Attach event listener for confirmation button
    document.getElementById('confirmDeleteBtn').onclick = function() {
        // Invoke the callback to delete the item
        callback();

        // Close the modal after delete is confirmed
        deleteModal.hide();
    };
}

// Function to show success toast
function showSuccessToast(message) {
    // Update the toast body with the custom message
    const toastBody = document.getElementById('successToast').querySelector('.toast-body');
    toastBody.textContent = message;

    // Initialize and show the toast
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    successToast.show();
}

$('#add-area-form').on('submit', function (e) {
    e.preventDefault();  
    console.log("Add Area Running");

    
    var formData = new FormData(this);
   

    // Debugging the formData
    for (var pair of formData.entries()) {
        console.log(pair[0]+ ', ' + pair[1]);
    }

    // Send the form data via AJAX
    $.ajax({
        url: '/api/area/create',
        type: 'POST', 
        data: formData, 
        processData: false,
        contentType: false, 
        success: function (response) {
            
          $('#add-area-model').modal('hide');
            
          showSuccessToast(`Area "${formData.get('area_name')}" added successfully!`);
                    
                    // Optionally, reload the page after success
                    setTimeout(function() {
                        location.reload();
                    }, 1500); // Delay to let the toast show before reloading
        },
        error: function (xhr, status, error) {
            console.error('Error adding area:', error);
            const response = JSON.parse(xhr.responseText);
            if(response.message==="area-found"){
              $('#zone_name_error').addClass('invalid-feedback'); // Mark the input as invalid
              $('#area_name_error').removeClass('invalid-feedback');
            } else if (response.message==="zone-found"){
              $('#zone_name_error').removeClass('invalid-feedback');
              $('#area_name_error').addClass('invalid-feedback'); 
            }
         
            // alert('Error: ' + response.message);
        }
    });
});

</script>
<%- include('../../partials/footer.ejs') %>
<%- include('../../partials/header.ejs', { title: title }) %>

  <div class="page-content">
    <!-- Main sidebar -->
    <%- include('../../partials/sidebar.ejs') %>
      <!-- /main sidebar -->

      <!-- Main content -->
      <div class="content-wrapper">
        <!-- Main navbar -->
        <%- include('../../component/dashboard/navbar.ejs') %>
          <!-- /main navbar -->

          <!-- Inner content -->
          <div class="content-inner">


            <!-- Content customer -->
            <div class="content">
              <!-- Nested object data -->
              <div class="card">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Customer </h5>
                    <!-- <button class="btn btn-light">Add Customer</button> -->
                    <!-- Button to trigger modal -->
                    <button type="button" class="btn btn-light" data-bs-toggle="modal"
                      data-bs-target="#add-customer-model">Add
                      Customer<i class="ph ph-user ms-2"></i></button>
                  </div>


                </div>


                <table class="table datatable-nested ">
                  <thead>
                    <tr>
                      <th>Customer Code</th>
                      <th>Customer Name</th>
                      <th>Categories</th>
                      <th>Products</th>
                      <th>Area</th>
                      <th>Firms</th>
                      <th>Grade</th>
                      <th>Status</th>
                      <th>Customer Status</th>
                      <th>Address</th>
                      <th>Pincode</th>
                      <th>Reference 1</th>
                      <th>Reference 1 Mobile </th>
                      <th>Reference 2</th>
                      <th>Reference 2 Mobile </th>
                      <th>Credit Limit</th>
                      <th>Credit Days</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Data will be dynamically injected here -->
                  </tbody>
                </table>

              </div>
              <!-- /nested object data -->


            </div>
            <!-- /content customer -->
          </div>
          <!-- /inner content -->
      </div>
      <!-- /main content -->
  </div>
  <!-- /page content -->

  <!-- Models -->

  <!-- add Customer Modal -->
  <div id="add-customer-model" class="modal fade" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-full">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-customer-form" >
            <div class="form-section mb-4">
              <!-- Generate Customer Code -->
              <h4 class="mb-4 text-primary">Generate Customer Code</h4>

              <div class="row align-items-center">
                <!-- Customer Code Input -->
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="customer_code" class="form-label">Customer Code</label>
                    <input type="text" id="customer_code" class="form-control" name="customer_code" minlength="4"
                      maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                      placeholder="Auto-generated code or type manually">
                    <small class="form-text text-muted">Click "Generate Now" to create a new customer code, or type it
                      manually.</small>
                  </div>
                </div>

                <!-- Generate Button -->
                <div class="col-md-4">
                  <div class="d-grid mb-3">
                    <button type="button" class="btn btn-primary" onclick="customerCodeGenerator()">Generate
                      Now</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Basic Information -->
            <div class="form-section mb-4">
              <h4 class="mb-3">Basic Information</h4>
              <div class="row">
                <!-- Customer Name -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="customer_name" class="form-label">Customer Name</label>
                    <input type="text" id="customer_name" class="form-control" name="customer_name" minlength="4"
                      maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                      >
                    <small class="form-text text-muted">As per official documents</small>
                  </div>
                </div>

                <!-- Status -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select if="status" class="form-control"  name="status">
                      <option value="" disabled selected>Select Status</option>
                      <option value="VERIFIED">VERIFIED</option>
                      <option value="UNVERIFIED">UNVERIFIED</option>
                    </select>
                    <small class="form-text text-muted">Indicate if customer is Verified</small>
                  </div>
                </div>

                <!-- Customer Status -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="customer_status" class="form-label">Customer Status</label>
                    <select class="form-control"  name="customer_status">
                      <option value="" disabled selected>Select Customer Status</option>
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                      <option value="closed">Closed</option>
                    </select>
                    <small class="form-text text-muted">Indicate if customer is active</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Address -->
            <div class="form-section mb-4">
              <div class="row">
                <!-- Customer Address -->
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="customer_address" class="form-label">Customer Address</label>
                    <input type="text" id="customer_address" class="form-control" name="customer_address" minlength="4"
                      maxlength="100">
                    <small class="form-text text-muted">Official address</small>
                  </div>
                </div>

                <!-- Customer Pincode -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="customer_pincode" class="form-label">Pincode</label>
                    <input type="number" id="customer_pincode" class="form-control" name="customer_pincode"
                      minlength="4" maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                      >
                    <small class="form-text text-muted">As per official documents</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Customer Grade -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Select Grade</label><button type="button" class="btn btn-link">Add New
                    Grade</button>
                  <select id="customer_grade" class="form-control multiselect" multiple="multiple" name="customer_grade"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% grades.forEach(function(item) { %>
                      <option value="<%= item.gradeId %>">
                        <%= item.gradeType %>
                      </option>
                      <% }) %>
                  </select>
                  <small class="form-text text-muted">Select the applicable grade</small>
                </div>
              </div>

              <!-- Customer area  -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Select areas</label><button type="button" class="btn btn-link">Add New
                    Area</button>
                  <select id="customer_area" class="form-control multiselect" multiple="multiple" name="customer_area"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% areas.forEach(function(item) { %>
                      <option value="<%= item.areaId %>">
                        <%= item.areaName %>
                      </option>
                      <% }) %>
                  </select>
                  <small class="form-text text-muted">Choose one or more area</small>
                </div>
              </div>
              <!-- Customer categories  -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Select Categories</label><button type="button" class="btn btn-link">Add New
                    Grade</button>
                  <select id="customer_categories" class="form-control multiselect" multiple="multiple" name="customer_categories"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% categories.forEach(function(item) { %>
                      <option value="<%= item.categoryId %>">
                        <%= item.categoryName %>
                      </option>
                      <% }) %>
                  </select>
                  <small class="form-text text-muted">Select the applicable categories</small>
                </div>
              </div>
            </div>

          

            <div class="row">
              <!-- Customer products -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Select product</label><button type="button" class="btn btn-link">Add New
                    Product</button>
                  <select id="customer_products" class="form-control multiselect" multiple="multiple" name="customer_products"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% products.forEach(function(item) { %>
                      <option value="<%= item.productId %>">
                        <%= item.productName %>
                      </option>
                      <% }) %>
                  </select>
                  <small class="form-text text-muted">Select the applicable products</small>
                </div>
              </div>

              <!-- Customer firms -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Select firms</label><button type="button" class="btn btn-link">Add New
                    Firm</button>
                  <select id="customer_firms" class="form-control multiselect" multiple="multiple" name="customer_firms"
                    data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                    <% firms.forEach(function(item) { %>
                      <option value="<%= item.firmId %>">
                        <%= item.firmName %>
                      </option>
                      <% }) %>
                  </select>
                  <small class="form-text text-muted">Choose one or more firm</small>
                </div>
              </div>
            </div>

            <!-- Customer Credit Information -->
            <div class="form-section mb-4">
              <h4 class="mb-3">Credit Information</h4>
              <div class="row">
                <!-- Credit -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_credit" class="form-label">Credit</label>
                    <input type="number" id="customer_credit" class="form-control" name="customer_credit" >
                    <small class="form-text text-muted">Amount of credit</small>
                  </div>
                </div>

                <!-- Credit Days -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_credit_days" class="form-label">Credit Days</label>
                    <input type="number" id="customer_credit_days" class="form-control" name="customer_credit_days"
                      >
                    <small class="form-text text-muted">Number of credit days</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer References -->
            <div class="form-section mb-4">
              <h4 class="mb-3">Customer References</h4>
              <div class="row">
                <!-- Reference 1 Name -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_reference_1_name" class="form-label">Reference 1 Name</label>
                    <input type="text" id="customer_reference_1_name" class="form-control" name="customer_reference_1_name" >
                    <small class="form-text text-muted">First reference name</small>
                  </div>
                </div>

                <!-- Reference 1 Contact -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_reference_1_contact" class="form-label">Reference 1 Contact</label>
                    <input type="text" id="customer_reference_1_contact" class="form-control" name="customer_reference_1_contact"
                      >
                    <small class="form-text text-muted">First reference contact</small>
                  </div>
                </div>
              </div>

              <div class="row">
                <!-- Reference 2 Name -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_reference_2_name" class="form-label">Reference 2 Name</label>
                    <input type="text" id="customer_reference_2_name" class="form-control" name="customer_reference_2_name" >
                    <small class="form-text text-muted">Second reference name</small>
                  </div>
                </div>

                <!-- Reference 2 Contact -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="customer_reference_2_contact" class="form-label">Reference 2 Contact</label>
                    <input type="text" id="customer_reference_2_contact" class="form-control" name="customer_reference_2_contact"
                      >
                    <small class="form-text text-muted">Second reference contact</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Contact Information -->
            <div class="form-section mb-4">
              <h4 class="mb-3">Owner Contact Information</h4>
              <div id="formRows">
                <div class="row mb-3 align-items-center">
                  <!-- Contact Name -->
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label for="customer_contact_name" class="form-label">Contact Name</label>
                      <input id="customer_contact_name" type="text" class="form-control" name="customer_contact_name" >
                      <small class="form-text text-muted">contact full name</small>
                    </div>
                  </div>

                  <!-- Contact Mobile -->
                  <div class="col-md-2">
                    <div class="mb-3">
                      <label for="customer_contact_mobile" class="form-label">Contact Mobile</label>
                      <input id="customer_contact_mobile" type="text" class="form-control" name="customer_contact_mobile" >
                      <small class="form-text text-muted">Contact mobile number</small>
                    </div>
                  </div>

                  <!-- Contact Email -->
                  <div class="col-md-3 ">
                    <div class="mb-3">
                      <label for="customer_contact_email" class="form-label">Contact Email</label>
                      <input id="customer_contact_email" type="email" class="form-control" name="customer_contact_email" >
                      <small class="form-text text-muted">contact email address</small>
                    </div>
                  </div>

                  <!-- Contact Designation -->
                  <div class="col-md-3 ">
                    <div class="mb-3">
                      <label for="customer_contact_designation" class="form-label">Contact Designation</label>
                      <input id="customer_contact_designation" type="text" class="form-control" name="customer_contact_designation">
                      <small class="form-text text-muted">contact designation</small>
                    </div>
                  </div>

                  <!-- Add Row Button -->
                  <div class="col-md-1">
                    <div class="mb-3 mt-1">
                      <button type="button" id="addRow" class="btn btn-primary">
                        <i class="ph ph-plus"></i> <!-- Bootstrap icon for Add -->
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Submission -->
            <div class="mb-4">
              <button type="submit" class="btn btn-success">Create Customer</button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

    <!-- add Customer Modal -->
    <div id="edit-customer-model" class="modal fade" tabindex="-1" style="display: none;" aria-hidden="true">
      <div class="modal-dialog modal-full">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Customer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="add-customer-form" >
              <div class="form-section mb-4">
                <!-- Generate Customer Code -->
                <h4 class="mb-4 text-primary">Generate Customer Code</h4>
  
                <div class="row align-items-center">
                  <!-- Customer Code Input -->
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="customer_code" class="form-label">Customer Code</label>
                      <input type="text" id="customer_code" class="form-control" name="customer_code" minlength="4"
                        maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                        placeholder="Auto-generated code or type manually">
                      <small class="form-text text-muted">Click "Generate Now" to create a new customer code, or type it
                        manually.</small>
                    </div>
                  </div>
  
                  <!-- Generate Button -->
                  <div class="col-md-4">
                    <div class="d-grid mb-3">
                      <button type="button" class="btn btn-primary" onclick="customerCodeGenerator()">Generate
                        Now</button>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Customer Basic Information -->
              <div class="form-section mb-4">
                <h4 class="mb-3">Basic Information</h4>
                <div class="row">
                  <!-- Customer Name -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="customer_name" class="form-label">Customer Name</label>
                      <input type="text" id="customer_name" class="form-control" name="customer_name" minlength="4"
                        maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                        >
                      <small class="form-text text-muted">As per official documents</small>
                    </div>
                  </div>
  
                  <!-- Status -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="status" class="form-label">Status</label>
                      <select if="status" class="form-control"  name="status">
                        <option value="" disabled selected>Select Status</option>
                        <option value="VERIFIED">VERIFIED</option>
                        <option value="UNVERIFIED">UNVERIFIED</option>
                      </select>
                      <small class="form-text text-muted">Indicate if customer is Verified</small>
                    </div>
                  </div>
  
                  <!-- Customer Status -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="customer_status" class="form-label">Customer Status</label>
                      <select class="form-control"  name="customer_status">
                        <option value="" disabled selected>Select Customer Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="closed">Closed</option>
                      </select>
                      <small class="form-text text-muted">Indicate if customer is active</small>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Customer Address -->
              <div class="form-section mb-4">
                <div class="row">
                  <!-- Customer Address -->
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="customer_address" class="form-label">Customer Address</label>
                      <input type="text" id="customer_address" class="form-control" name="customer_address" minlength="4"
                        maxlength="100">
                      <small class="form-text text-muted">Official address</small>
                    </div>
                  </div>
  
                  <!-- Customer Pincode -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="customer_pincode" class="form-label">Pincode</label>
                      <input type="number" id="customer_pincode" class="form-control" name="customer_pincode"
                        minlength="4" maxlength="20" pattern="^[A-Za-z0-9]+(?: [A-Za-z0-9]+)*$"
                        >
                      <small class="form-text text-muted">As per official documents</small>
                    </div>
                  </div>
                </div>
              </div>
  
              <div class="row">
                <!-- Customer Grade -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Select Grade</label><button type="button" class="btn btn-link">Add New
                      Grade</button>
                    <select id="customer_grade" class="form-control multiselect" multiple="multiple" name="customer_grade"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% grades.forEach(function(item) { %>
                        <option value="<%= item.gradeId %>">
                          <%= item.gradeType %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Select the applicable grade</small>
                  </div>
                </div>
  
                <!-- Customer area  -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Select areas</label><button type="button" class="btn btn-link">Add New
                      Area</button>
                    <select id="customer_area" class="form-control multiselect" multiple="multiple" name="customer_area"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% areas.forEach(function(item) { %>
                        <option value="<%= item.areaId %>">
                          <%= item.areaName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Choose one or more area</small>
                  </div>
                </div>
                <!-- Customer categories  -->
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Select Categories</label><button type="button" class="btn btn-link">Add New
                      Grade</button>
                    <select id="customer_categories" class="form-control multiselect" multiple="multiple" name="customer_categories"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% categories.forEach(function(item) { %>
                        <option value="<%= item.categoryId %>">
                          <%= item.categoryName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Select the applicable categories</small>
                  </div>
                </div>
              </div>
  
            
  
              <div class="row">
                <!-- Customer products -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Select product</label><button type="button" class="btn btn-link">Add New
                      Product</button>
                    <select id="customer_products" class="form-control multiselect" multiple="multiple" name="customer_products"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% products.forEach(function(item) { %>
                        <option value="<%= item.productId %>">
                          <%= item.productName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Select the applicable products</small>
                  </div>
                </div>
  
                <!-- Customer firms -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Select firms</label><button type="button" class="btn btn-link">Add New
                      Firm</button>
                    <select id="customer_firms" class="form-control multiselect" multiple="multiple" name="customer_firms"
                      data-enable-filtering="true" data-enable-case-insensitive-filtering="true">
                      <% firms.forEach(function(item) { %>
                        <option value="<%= item.firmId %>">
                          <%= item.firmName %>
                        </option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Choose one or more firm</small>
                  </div>
                </div>
              </div>
  
              <!-- Customer Credit Information -->
              <div class="form-section mb-4">
                <h4 class="mb-3">Credit Information</h4>
                <div class="row">
                  <!-- Credit -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_credit" class="form-label">Credit</label>
                      <input type="number" id="customer_credit" class="form-control" name="customer_credit" >
                      <small class="form-text text-muted">Amount of credit</small>
                    </div>
                  </div>
  
                  <!-- Credit Days -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_credit_days" class="form-label">Credit Days</label>
                      <input type="number" id="customer_credit_days" class="form-control" name="customer_credit_days"
                        >
                      <small class="form-text text-muted">Number of credit days</small>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Customer References -->
              <div class="form-section mb-4">
                <h4 class="mb-3">Customer References</h4>
                <div class="row">
                  <!-- Reference 1 Name -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_reference_1_name" class="form-label">Reference 1 Name</label>
                      <input type="text" id="customer_reference_1_name" class="form-control" name="customer_reference_1_name" >
                      <small class="form-text text-muted">First reference name</small>
                    </div>
                  </div>
  
                  <!-- Reference 1 Contact -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_reference_1_contact" class="form-label">Reference 1 Contact</label>
                      <input type="text" id="customer_reference_1_contact" class="form-control" name="customer_reference_1_contact"
                        >
                      <small class="form-text text-muted">First reference contact</small>
                    </div>
                  </div>
                </div>
  
                <div class="row">
                  <!-- Reference 2 Name -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_reference_2_name" class="form-label">Reference 2 Name</label>
                      <input type="text" id="customer_reference_2_name" class="form-control" name="customer_reference_2_name" >
                      <small class="form-text text-muted">Second reference name</small>
                    </div>
                  </div>
  
                  <!-- Reference 2 Contact -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customer_reference_2_contact" class="form-label">Reference 2 Contact</label>
                      <input type="text" id="customer_reference_2_contact" class="form-control" name="customer_reference_2_contact"
                        >
                      <small class="form-text text-muted">Second reference contact</small>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Customer Contact Information -->
              <div class="form-section mb-4">
                <h4 class="mb-3">Owner Contact Information</h4>
                <div id="formRows">
                  <div class="row mb-3 align-items-center">
                    <!-- Contact Name -->
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="customer_contact_name" class="form-label">Contact Name</label>
                        <input id="customer_contact_name" type="text" class="form-control" name="customer_contact_name" >
                        <small class="form-text text-muted">contact full name</small>
                      </div>
                    </div>
  
                    <!-- Contact Mobile -->
                    <div class="col-md-2">
                      <div class="mb-3">
                        <label for="customer_contact_mobile" class="form-label">Contact Mobile</label>
                        <input id="customer_contact_mobile" type="text" class="form-control" name="customer_contact_mobile" >
                        <small class="form-text text-muted">Contact mobile number</small>
                      </div>
                    </div>
  
                    <!-- Contact Email -->
                    <div class="col-md-3 ">
                      <div class="mb-3">
                        <label for="customer_contact_email" class="form-label">Contact Email</label>
                        <input id="customer_contact_email" type="email" class="form-control" name="customer_contact_email" >
                        <small class="form-text text-muted">contact email address</small>
                      </div>
                    </div>
  
                    <!-- Contact Address -->
                    <div class="col-md-3 ">
                      <div class="mb-3">
                        <label for="customer_contact_address" class="form-label">Contact Address</label>
                        <input id="customer_contact_address" type="text" class="form-control" name="customer_contact_address">
                        <small class="form-text text-muted">contact address</small>
                      </div>
                    </div>
  
                    <!-- Add Row Button -->
                    <div class="col-md-1">
                      <div class="mb-3 mt-1">
                        <button type="button" id="addRow" class="btn btn-primary">
                          <i class="ph ph-plus"></i> <!-- Bootstrap icon for Add -->
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Form Submission -->
              <div class="mb-4">
                <button type="submit" class="btn btn-success">Create Customer</button>
              </div>
            </form>
  
          </div>
        </div>
      </div>
    </div>


 <script>
  // Function to render area table
function renderAreaTable() {
    renderTable({
        tableClassName: '.datatable-nested', 
        apiURl: '/api/customers', 
        columns: [
            { data: "customerCode" },
            { data: "customerName" },
            {
                data: "categories",
                render: function (data, type, row) {
                    return Array.isArray(data) && data.length > 0
                        ? data.map(category => category.categoryName).join(', ')
                        : 'No categories';
                }
            },
            {
                data: "products",
                render: function (data, type, row) {
                    return Array.isArray(data) && data.length > 0
                        ? data.map(product => product.productName).join(', ')
                        : 'No products';
                }
            },
            { 
                data: "area.areaName", 
                defaultContent: 'No area'  // Handling missing area
            },
            {
                data: "firms",
                render: function (data, type, row) {
                    return Array.isArray(data) && data.length > 0
                        ? data.map(firm => firm.firmName).join(', ')
                        : 'No firms';
                }
            },
            { 
                data: "grade.gradeType", 
                defaultContent: 'No grade'  // Handling missing grade
            },
            { data: "status" },
            { data: "customerStatus" },
            { data: "address" },
            { data: "pincode" },
            { data: "referenceName1" },
            { data: "reference1ContactNumber" },
            { data: "referenceName2" },
            { data: "reference2ContactNumber" },
            { data: "creditLimit" },
            { data: "creditDays" },
            {
                data: null,
                className: "text-center",
                render: function (data, type, row) {
                    return `
                        <button type="button" class="btn btn-primary btn-sm" 
                                onclick="setData('${row.customerId}', '${row.customerName}')">
                            <i class="ph ph-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm ms-2" 
                                onclick="deleteData('${row.customerId}', '${row.customerName}')">
                            <i class="ph ph-trash"></i>
                        </button>
                    `;
                }
            }
        ]
    });
}

// Function to add a new customer
function addCustomer() {
    // Event delegation to handle form submission
    $(document).on('submit', '#add-customer-form', function (e) {
        e.preventDefault();
        
        const formData = new FormData(this);  // Form data from the form
        
        // Collect all dynamic rows
        const rows = document.querySelectorAll('#formRows .row');  // Each dynamic row inside formRows
        const customerContacts = [];

        rows.forEach((row) => {
            // Get the input values for each row
            const contactName = row.querySelector('[name="customer_contact_name"]')?.value;
            const contactMobile = row.querySelector('[name="customer_contact_mobile"]')?.value;
            const contactEmail = row.querySelector('[name="customer_contact_email"]')?.value;
            const contactDesignation = row.querySelector('[name="customer_contact_designation"]')?.value;

            // Check if all fields are filled, skip empty rows
            if (contactName && contactMobile && contactEmail && contactDesignation) {
                // Create an object for this row's data
                const contactData = {
                  contactName: contactName,
                    mobile: contactMobile,
                    email: contactEmail,
                    designation: contactDesignation
                };

                // Append the object to the customerContacts array
                customerContacts.push(contactData);
            }
        });

        // Append the array of customer contacts to FormData as a JSON string
        formData.append('customerContacts', JSON.stringify(customerContacts));

        // Send AJAX request with formData
        $.ajax({
            url: '/api/customer/create',  // API endpoint
            method: 'POST',
            processData: false,  // Required for FormData
            contentType: false,  // Required for FormData
            data: formData,
            success: function (response) {
                $('#add-customer-model').modal('hide');
                showSuccessToast(`Customer "${formData.get('customer_name')}" added successfully!`);
                setTimeout(() => location.reload(), 1500);  // Reload page after success
            },
            error: function (xhr) {
                console.error('Error adding customer:', xhr);
                const response = JSON.parse(xhr.responseText);
                handleErrorResponse(response);
            }
        });
    });
}

// Function to handle error responses
function handleErrorResponse(response) {
    if (response.message === "area-found") {
        $('#zone_name_error').addClass('invalid-feedback');
        $('#area_name_error').removeClass('invalid-feedback');
    } else if (response.message === "zone-found") {
        $('#zone_name_error').removeClass('invalid-feedback');
        $('#area_name_error').addClass('invalid-feedback');
    }
}

// Function to delete Customer
function deleteData(id, customerName) {
    if (!id) {
        alert("Invalid ID for deletion.");
        return;
    }

    // Show confirmation modal with the customer name
    showDeleteConfirmationModal(customerName, () => {
        ajaxRequest(`/api/customer/delete/${id}`, 'DELETE', null, function(response) {
            if (response.success) {
                showSuccessToast(`Customer "${customerName}" deleted successfully!`);
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Error: ' + response.message);
            }
        }, function(xhr) {
            console.error('Error deleting data:', xhr);
            alert('Failed to delete data. Please try again.');
        });
    });
}

// Function to generate customer code in customer form model
function customerCodeGenerator(length = 8) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = 'CUST'; // Prefix for the customer code

    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        result += characters[randomIndex];
    }

    document.getElementById('customer_code').value = result;
}

// Add a new row in the customer form model
document.getElementById('addRow').addEventListener('click', function () {
    const formRows = document.getElementById('formRows');
    const newRow = document.createElement('div');
    newRow.classList.add('row', 'mb-3', 'align-items-center');
    newRow.innerHTML = `
        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">Contact Name</label>
                <input type="text" class="form-control" name="customer_contact_name" >
                <small class="form-text text-muted">Contact full name</small>
            </div>
        </div>

        <div class="col-md-2">
            <div class="mb-3">
                <label class="form-label">Contact Mobile</label>
                <input type="text" class="form-control" name="customer_contact_mobile" >
                <small class="form-text text-muted">Contact mobile number</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">Contact Email</label>
                <input type="email" class="form-control" name="customer_contact_email" >
                <small class="form-text text-muted">Contact email address</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">Contact Designation</label>
                <input type="text" class="form-control" name="customer_contact_designation">
                <small class="form-text text-muted">contact designation</small>
            </div>
        </div>

        <!-- Remove row button -->
        <div class="col-md-1">
            <div class="mb-3 mt-1">
                <button type="button" class="btn btn-danger removeRow">
                    <i class="ph ph-minus"></i>
                </button>
            </div>
        </div>
    `;
    formRows.appendChild(newRow);
});

// Event delegation for removing a row
document.getElementById('formRows').addEventListener('click', function (e) {
    if (e.target.classList.contains('removeRow') || e.target.closest('.removeRow')) {
        e.target.closest('.row').remove();
    }
});

// Initialize the area table and bind add customer function
$(document).ready(function() {
    renderAreaTable();
    addCustomer();
});

 </script>

  <%- include('../../partials/footer') %>